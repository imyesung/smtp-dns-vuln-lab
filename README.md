# SMTP & DNS Vulnerability Lab

> **[주의] 본 프로젝트는 보안 연구 및 교육 목적에 한하여 사용해야 합니다.**  
> 외부 네트워크 또는 실제 운영 환경에서 이 실험을 수행하지 마십시오.  
> 실험 대상은 로컬 Docker 네트워크 내에 격리되어야 하며,  
> 작성자는 실험 내용을 무단으로 사용하거나 악용한 행위에 대해 책임지지 않습니다.

## Objectives

- Docker 기반의 이메일 시스템(Postfix, DNSMasq 등)을 구축한다.
- SMTP, POP3, IMAP의 전체 흐름(작성 → 송신 → 수신 → 열람)을 이해한다.
- 오픈 릴레이, SPF 위조, DNS 재귀 질의 등 주요 취약점을 실험한다.
- 취약점 공격 → 패치 적용 → 결과 분석 흐름을 자동화한다.
- HTML 기반 리포트(필요 시 PDF)로 정리하여 문서화한다.

## Assumptions

- 이메일 시스템에 대한 사전 지식이 없는 상태를 기준으로 설계되었다.
- 실험은 반드시 로컬 Docker 네트워크 내부에서만 수행되어야 한다.
- 모든 구성은 외부 인터넷과 단절된 환경에서 실행된다.
- 실험에 사용되는 도메인, 메일 주소, 서버는 모두 가상의 것이다.

## File Structure

| 경로 / 파일명               | 설명                                          |
|----------------------------|-----------------------------------------------|
| `README.md`                | 프로젝트 개요 및 실험 실행 설명                |
| `lab-notebook.md`          | 전체 실험 흐름 및 단계별 계획 정리             |
| `docker-compose.yml`       | 경량 실험 환경 구성 (3개 기본 컨테이너)        |
| `docker-compose.full.yml`  | 심화 실험 환경 구성 (포트 매핑 포함)           |
| `Makefile`                 | 실험 자동화 스크립트 (`make demo` 등)         |
| `scripts/`                 | 공격, 강화, 보고서 자동화를 위한 쉘 스크립트 |
| `configs/`                 | Postfix, DNSMasq 설정 파일 템플릿              |
| `artifacts/`               | 로그, 리포트, 캡처 파일 저장 디렉토리         |

## Demo Flow

```
make demo
└─ mua-alpine 컨테이너에서 인증 없는 메일 전송 (공격)
└─ mail-postfix 컨테이너에서 설정 변경 (보안 강화)
└─ mua-alpine에서 다시 동일 공격 실행 (검증)
└─ before.log / after.log 비교 후 HTML 리포트 생성
```

## 실행 방법
```bash
# 기본 실험 흐름 실행 (오픈 릴레이 → 패치 → 검증)
make demo

# 전체 실험 환경 구성
make full

# 취약점 실험만 실행
make test-vulnerabilities

# 보안 패치 적용 및 효과 검증
make secure-and-verify

# 최종 보고서 생성
make report
```
## 네트워크 아키텍처

| 네트워크 이름 | 용도                            | 서브넷(CIDR)     |
|---------------|---------------------------------|------------------|
| smtp-net      | Postfix 서버, 클라이언트(MUA)   | 172.30.0.0/24    |
| dns-net       | DNSMasq 서버, SPF 테스트용      | 172.30.1.0/24    |
| mgmt-net      | 패킷 캡처 및 리포트 수집용      | 172.30.2.0/24    |

## 주요 실험 항목

| 실험 주제             | 요약 설명                                            |
|----------------------|-----------------------------------------------------|
| 오픈 릴레이 구성 및 차단 | 인증 없이 메일 릴레이가 가능한지 실험하고 차단         |
| SPF 스푸핑 실험        | 약한 SPF 레코드(~all)로 인한 위조 메일 시도 실험       |
| STARTTLS 미지원       | 평문 인증 전송 구조를 확인하고 tcpdump로 캡처         |
| DNS 재귀 질의 분석     | 재귀 질의 설정 시 증폭 공격 가능성 확인                |

## 보고서 생성
- `scripts/gen_report_html.sh`: HTML 기반 보고서 자동 생성
- 결과는 `artifacts/demo-<timestamp>.html`로 저장
- 향후 PDF 변환 기능은 TinyTeX 기반으로 추가 고려 중

## 유의 사항
- 실험은 교육 및 보안 훈련 목적에 한하여 사용되어야 한다.
- 외부 도메인 또는 운영 시스템에 이 실험 코드를 적용하지 않는다.
- 모든 로그, 캡처 파일은 artifacts/ 디렉토리에 자동 저장된다.
- 공격 코드 및 스크립트는 윤리적 목적에 맞게 검토 후 사용해야 한다.